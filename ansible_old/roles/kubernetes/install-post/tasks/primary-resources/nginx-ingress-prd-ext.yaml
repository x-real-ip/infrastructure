---
- name: Test namespace {{ item.namespace }}
  ansible.builtin.include_tasks: namespace.yaml
  when: item.namespace is defined

- name: Download manifest from github and apply to the k3s cluster
  ansible.builtin.include_tasks: deploy.yaml
  when: '"github" in item.source'

- name: Validate deployment | {{ item.name }}
  kubernetes.core.k8s_info:
    kind: Deployment
    name: ingress-nginx-prd-ext-controller
    namespace: "prd-ext"
    label_selectors:
      - "app.kubernetes.io/instance=ingress-nginx-prd-ext"
    wait: true
    wait_condition:
      type: Available
      status: "True"

- name: Validate if pod is ready | {{ item.name }}
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "prd-ext"
    label_selectors:
      - "{{ label }}"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
  loop_control:
    loop_var: label
  vars:
    label:
      - "app.kubernetes.io/component=controller"
