---
- name: Test namespace {{ item.namespace }}
  ansible.builtin.include_tasks: namespace.yaml
  when: item.namespace is defined

- name: Read kube config file as base64(slurp) for drone secret
  ansible.builtin.slurp:
    src: "{{ ansible_user_dir }}/.kube/config"
  register: base64_kubeconfig
  run_once: true

- name: Apply drone kube config secret to the k3s cluster
  kubernetes.core.k8s:
    state: present
    template: "drone-kubeconfig-secret.yaml.j2"
  run_once: true

- name: Download manifest from github and apply to the k3s cluster | {{ item.name }}
  ansible.builtin.include_tasks: deploy.yaml
  when: '"github" in item.source'

- name: Validate if pods are ready | {{ item.name }}
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "devops"
    label_selectors:
      - "{{ labels }}"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_sleep: 10
    wait_timeout: 360
  with_items:
    - "app=drone-server"
    - "app=drone-runner-docker"
    - "app=drone-secrets"
  loop_control:
    loop_var: labels
